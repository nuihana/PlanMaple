<?xml version="1.0" encoding="UTF-8"?>
 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="managecode">

	<select id="selectManagementCodeInfo" parameterType="ManagementVo" resultType="ManagecodeVo">
		SELECT *
		FROM PM_MANAGEMENTCODE
		WHERE MANAGEMENT_CODE = #{management_code}
	</select>

	<select id="selectManagementCodeList" parameterType="CharacterVo" resultType="ManagecodeVo">
		SELECT *
		FROM PM_MANAGEMENTCODE
		WHERE (PUBLIC_FLAG = '0' OR PUBLIC_FLAG = #{user_seq})
		ORDER BY MANAGEMENT_CODE
	</select>

	<select id="selectManagementCodeListByCondition" parameterType="hashMap" resultType="ManagecodeVo">
		SELECT *
		FROM PM_MANAGEMENTCODE
		WHERE CYCLE_CONDITION = #{cycle}
	</select>
	
	<insert id="insertManagecode" parameterType="ManagecodeVo">
		<selectKey resultType="String" keyProperty="management_code" order="BEFORE">
			SELECT CONCAT('ZYX_', #{public_flag}, '_', LPAD(MAX(CAST(REGEXP_REPLACE(MANAGEMENT_CODE, '[^0-9]','') AS UNSIGNED)) + 1, '4', '0')) FROM PM_MANAGEMENTCODE WHERE MANAGEMENT_CODE = 'ZYX_0000' OR PUBLIC_FLAG = #{public_flag};
		</selectKey>
		INSERT INTO PM_MANAGEMENTCODE (
			MANAGEMENT_CODE, MANAGEMENT_CODE_DESC, PARANT_CODE, BELONG_CONDITION, CYCLE_CONDITION, COMPLETE_COUNT, PUBLIC_FLAG
		) VALUES (
			#{management_code}, #{management_code_desc}, 'ZYX_0000', #{belong_condition}, #{cycle_condition}, #{complete_count}, #{public_flag}
		)
	</insert>

	<select id="selectDeadlineManagecodeList" parameterType="hashMap" resultType="ManagecodeVo">
		SELECT *
		FROM PM_MANAGEMENTCODE
		WHERE (PUBLIC_FLAG = '0' OR PUBLIC_FLAG = #{user_seq})
		AND (
			CYCLE_CONDITION = 'D'
			<choose>
				<when test='day == "7"'>
					OR CYCLE_CONDITION = 'S'
				</when>
				<when test='day == "3"'>
					OR CYCLE_CONDITION = 'T'
				</when>
			</choose>
		)
	</select>
	
</mapper>